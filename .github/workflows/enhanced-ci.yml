name: ðŸš€ Enhanced CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

jobs:
  quality-gate:
    runs-on: ubuntu-latest
    name: ðŸ” Quality Gate
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ðŸ“¦ Install dependencies
      run: npm ci
      
    - name: ðŸ§¹ Run ESLint
      run: npm run lint
      
    - name: ðŸ”§ TypeScript type check
      run: npx tsc --noEmit
      
    - name: ðŸ—ï¸ Build application
      run: npm run build
      
    - name: ðŸ“Š Build size analysis
      run: |
        echo "## ðŸ“Š Build Analysis" >> $GITHUB_STEP_SUMMARY
        echo "Build completed successfully! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
        if [ -d "dist" ]; then
          echo "### ðŸ“¦ Bundle Sizes" >> $GITHUB_STEP_SUMMARY
          du -sh dist/* | head -10 >> $GITHUB_STEP_SUMMARY
        fi

  security-audit:
    runs-on: ubuntu-latest
    name: ðŸ”’ Security Audit
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ðŸ“¦ Install dependencies
      run: npm ci
      
    - name: ðŸ” Security audit
      run: npm audit --audit-level=moderate
      
    - name: ðŸ›¡ï¸ Check for vulnerabilities
      run: |
        echo "## ðŸ”’ Security Report" >> $GITHUB_STEP_SUMMARY
        npm audit --json | jq -r '.metadata | "Found \(.vulnerabilities.total) vulnerabilities (\(.vulnerabilities.high) high, \(.vulnerabilities.moderate) moderate)"' >> $GITHUB_STEP_SUMMARY

  build-electron:
    runs-on: ${{ matrix.os }}
    name: ðŸ–¥ï¸ Build Electron App
    needs: [quality-gate]
    if: startsWith(github.ref, 'refs/tags/v')
    
    strategy:
      matrix:
        os: [macos-latest, windows-latest, ubuntu-latest]
        
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ðŸ“¦ Install dependencies
      run: npm ci
      
    - name: ðŸ—ï¸ Build React app
      run: npm run build
      
    - name: ðŸ“± Package Electron app
      run: npm run electron:pack
      
    - name: ðŸ“¤ Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: electron-${{ matrix.os }}
        path: dist-electron/
        retention-days: 30

  deploy-preview:
    runs-on: ubuntu-latest
    name: ðŸŒ Deploy Preview
    needs: [quality-gate]
    if: github.event_name == 'pull_request'
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ðŸ“¦ Install dependencies
      run: npm ci
      
    - name: ðŸ—ï¸ Build for preview
      run: npm run build
      
    - name: ðŸš€ Deploy to Netlify (Preview)
      uses: netlify/actions/cli@master
      with:
        args: deploy --dir=dist --alias=pr-${{ github.event.number }}
      env:
        NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}

  create-release:
    runs-on: ubuntu-latest
    name: ðŸ·ï¸ Create Release
    needs: [quality-gate, security-audit, build-electron]
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ·ï¸ Create GitHub Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: ZATCA Invoice Creator ${{ github.ref }}
        body: |
          ## ðŸŽ‰ ZATCA Invoice Creator Release
          
          ### âœ… What's Included
          - ðŸ‡¸ðŸ‡¦ ZATCA Phase 2 compliant invoice generation
          - ðŸ“± Cross-platform Electron desktop application
          - ðŸŒ Web application for browser use
          - ðŸ“„ Comprehensive documentation and guides
          
          ### ðŸš€ Quick Start
          1. Download the appropriate version for your platform
          2. Follow the setup instructions in README.md
          3. Start creating ZATCA-compliant invoices immediately!
          
          ### ðŸ“Š Quality Metrics
          - âœ… Zero TypeScript errors
          - âœ… Zero ESLint warnings
          - âœ… Security audit passed
          - âœ… Cross-platform compatibility verified
          
          **Ready for production use in Saudi Arabian businesses! ðŸ‡¸ðŸ‡¦**
        draft: false
        prerelease: false

  notify-success:
    runs-on: ubuntu-latest
    name: ðŸŽ‰ Success Notification
    needs: [quality-gate, security-audit]
    if: success()
    
    steps:
    - name: ðŸŽŠ Success Summary
      run: |
        echo "## ðŸŽ‰ Pipeline Success!" >> $GITHUB_STEP_SUMMARY
        echo "All quality gates passed successfully!" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Completed Checks" >> $GITHUB_STEP_SUMMARY
        echo "- Lint & Type Check" >> $GITHUB_STEP_SUMMARY
        echo "- Security Audit" >> $GITHUB_STEP_SUMMARY
        echo "- Build Verification" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸš€ **Ready for deployment!**" >> $GITHUB_STEP_SUMMARY
